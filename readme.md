# Детектирования+валидации пачек по QR-кодам + извещение сервера о них

## Пример
Скрипт, который постоянно обрабатывает видео с камеры и, когда что-то определённое случается,
посылает извещение на удалённый сервер.

## Структура проекта
```
.
├── pallet_confiscation_tracker
│   │
│   │ # Классы-обёртки, асинхронно отправляющие запросы
│   │ # (это могут быть запросы к бд, api, snmp-контроллерам и т.п.)
│   ├── senders  # (компонент для DI-инъекций)
│   │   ├── _senders.py
│   │   └── _methods.py
│   │
│   │ # Классы-детекторы, использующие разные методы детектирования объектов
│   ├── detectors  # (компонент для DI-инъекций)
│   │   ├── _detectors.py
│   │   └── _methods.py
│   │
│   │ # Тут могут быть другие ВАШИ компоненты для видеообработки
│   ├── ...
│   │
│   │ # Функции с получением нужного региона с изображения камеры
│   ├── regions_extraction.py
│   │ # Универсальные функции для работы с изображениями
│   └── utils.py
│   │
│   │ # DataInjection-контейнеры
│   │ # (в зависимости от значений в конфиге выбрают класс-реализацию и настраивают его)
│   ├── di_containers.py
│   │ # Главный скрипт с обработкой видео
│   │ # (объединяет в себе непрерывную обработку видео, логику и отправку запросов)
│   ├── processing.py
│   │ # Скрипт с предварительной инициализиацией необходимых компонентов и запуском
│   │ # (получает данные из DI-контейнеров и начинает видеообработку)
│   └── main.py
│
│ # запуск main'а main.py
├── main.py
│
│ # Этот файл. Содержит описание проекта-шаблона
├── readme.md
│ # Сторонние зависимости проекта
├── requirements.txt
│ # Конфиг "по умолчанию". Копируется, если не найден конфиг пользователя.
├── sample_config.yaml
├── .gitignore
│
│ # Конфиг с настройками пользователя (находится в .gitignore)
├── config.yaml
└── logs
    │ # Логи пользователя (находятся в .gitignore)
    └── ...
```

## Какие проблемы уже решает этот проект?

### Логгирование
Здесь используется loguru для логирования, ротации и сжатия логов.
loguru корректно работает при записи логов из разных потоков, в
случае мультипроцессной записи в один лог достаточно добавить `enqueue=True` в настройки logger'а.

### Конфигурация
Через конфиг можно настроить работу приложения.
Инъекция зависимостей (DI) позволяет менять реализации того или иного компонента без необходимости лезть в код.

Например, можно поменять детектирование простым фильтром цвета на нейросеть, изменив пару строчек конфига.
Аналогично не вызывает проблем поменять адрес сервера, которому необходимо отправлять запросы.

### Оптимальная отправка сетевых запросов
Сетевых запросы (IO-Bound) отправляются асинхронно без блокировки всей программы.
При этом влияние на непрерывную обработку видео (CPU-Bound) сведено к минимуму.

Для этого здесь используется `asyncio.eventloop`, работающий в параллельном потоке.

(В качестве альтернативы можно было использовать `requests`-запросы в отдельных потоках, но при большом кол-ве 
одновременных запросов это бы приводило к частым переключениям контекста и снижению производительности)

### Многопоточная обработка видео
Кадры в `processing.py` распараллеливаются на несколько потоков, 
что позволяет увеличить скорость обработки данных на тяжёлых операциях.

## Как это поддерживать

### DI-инъекции и конфигурация

Для внедрения зависимостей тут используется библиотека `dependency_injector`.

Чтобы новые добавленные вами классы можно было менять прямо из конфига
необходимо в файле `di_containers.py` добавить возможность выбора вашего класса 
и перенести из конфига все параметры, которые ожидает ваш класс в конструкторе.

Можно посмотреть в `di_containers.py`, как это уже реализовано 
для классов из `pack_trackers.py` и `pack_detectors.py`, посмотреть примеры 
в репозитории [dependency_injector](https://github.com/ets-labs/python-dependency-injector/)
или изучить [какой-нибудь гайд](
https://medium.com/@rmogylatov/dependency-injector-python-dependency-injection-framework-eeb9f5c6db8b).

### Многопоточная обработка

TODO: добавить комментарии про правильное распараллеливание 
с удалением логики и глобальных переменных из `process_frame`.
